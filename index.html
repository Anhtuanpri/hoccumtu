<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>V·ªü L·∫≠t Trang ‚Äî S·ªï t·ª´ v·ª±ng</title>
<meta name="description" content="V·ªü l·∫≠t trang full m√†n h√¨nh, 2 font (ƒë√°nh m√°y & vi·∫øt tay), l∆∞u localStorage. B·ªô ƒë·ªãnh d·∫°ng n·ªïi: ƒë·ªïi m√†u t·ª´ng ch·ªØ & in ƒë·∫≠m.">
<style>
  :root{
    --bg:#f2f3f7;
    --paper:#fffdfa;
    --ink:#111;
    --rule:#e7e4db;
    --accent:#1a73e8;
    --shadow:rgba(0,0,0,.14);
    --corner:#eee9dc;
    --ring:#e0e0e0;
    --font-type: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    --font-hand: "Segoe Print","Bradley Hand","Comic Sans MS","Chalkboard SE","Noteworthy","Snell Roundhand",cursive;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); font-family:var(--font-type); color:var(--ink); overflow:hidden}

  .stage{position:fixed; inset:0; display:grid; place-items:center; padding:clamp(8px,2.5vw,24px)}
  .book{position:relative; width:min(1200px, 100vw); height:100svh; perspective:2200px}
  .page{
    position:absolute; inset:0; margin:auto; width:100%; height:100%;
    background:var(--paper); border-radius:18px;
    box-shadow:0 24px 40px -16px rgba(0,0,0,.28), 0 6px 18px rgba(0,0,0,.10);
    overflow:hidden; transform-style:preserve-3d;
  }
  .paper{
    position:absolute; inset:0; padding:28px clamp(18px,2.2vw,30px);
    overflow:auto; -webkit-overflow-scrolling:touch;
    font-size: clamp(17px, 1.35vw, 22px); line-height:1.9;
    background:
      repeating-linear-gradient(to bottom, transparent 0 28px, var(--rule) 28px 29px),
      linear-gradient(90deg, rgba(26,115,232,.25), rgba(26,115,232,.25)) left 64px top 0/2px 100% no-repeat,
      linear-gradient(#fff,#fff);
  }
  .paper:focus{outline:none}
  .paper .ghost{color:#8b8b8b; font-style:italic}

  .flip-layer{position:absolute; inset:0; transform-origin:98% 50%; pointer-events:none}
  .flip-layer::before, .flip-layer::after{content:""; position:absolute; inset:0; pointer-events:none}
  .flip-layer::before{
    background: radial-gradient(120% 140% at 100% 50%, rgba(0,0,0,.22), rgba(0,0,0,0) 60%) right/60% 100% no-repeat,
                linear-gradient(90deg, rgba(0,0,0,.10), rgba(0,0,0,0));
    mix-blend-mode:multiply; opacity:0; transition:opacity .25s;
  }
  .flip-layer::after{
    background: linear-gradient(90deg, rgba(255,255,255,.6), rgba(255,255,255,0) 35%),
                linear-gradient(90deg, rgba(0,0,0,.10), rgba(0,0,0,0) 45%);
    opacity:0; transition:opacity .25s;
  }
  .page.lifting .flip-layer::before,
  .page.lifting .flip-layer::after{opacity:1}

  .corner{
    position:absolute; right:0; bottom:0; width:72px; height:72px;
    background:conic-gradient(from 225deg at 100% 100%, var(--corner), var(--corner) 25%, transparent 0);
    filter: drop-shadow(-1px -1px 0 rgba(0,0,0,.08));
    opacity:.9; pointer-events:none;
  }

  /* ch·ªâ ‚Äúg·ªù‚Äù 64px ·ªü m√©p ƒë·ªÉ l·∫≠t; ph·∫ßn gi·∫•y click l√† ƒë·ªÉ g√µ */
  .zones{position:absolute; inset:0; pointer-events:none}
  .zones .left, .zones .right{
    position:absolute; top:0; width:64px; height:100%;
    pointer-events:auto; cursor:pointer;
  }
  .zones .left{left:0; cursor:w-resize}
  .zones .right{right:0; cursor:e-resize}

  .footer{position:absolute; bottom:10px; left:0; right:0; display:flex; justify-content:center;
    pointer-events:none; color:#666; text-shadow:0 1px 0 #fff; font-size:.95rem}
  .footer .pill{background:#fff; border:1px solid #e6e6e6; border-radius:20px; padding:.25rem .7rem; box-shadow:0 4px 10px rgba(0,0,0,.08); pointer-events:auto}

  .gear{
    position:absolute; top:14px; right:14px; z-index:5;
    width:46px; height:46px; border-radius:50%;
    background:#fff; border:1px solid var(--ring); display:grid; place-items:center;
    box-shadow:0 10px 24px rgba(0,0,0,.20); cursor:pointer; user-select:none;
  }
  .gear:hover{border-color:#cfcfcf}

  .panel{
    position:absolute; top:0; right:0; height:100%; width:min(380px, 92vw);
    background:rgba(255,255,255,.98); border-left:1px solid #e9e9e9;
    box-shadow:-18px 0 40px -16px rgba(0,0,0,.25);
    transform:translateX(100%); transition: transform .28s ease;
    z-index:6; display:flex; flex-direction:column; backdrop-filter: blur(6px) saturate(1.1);
  }
  .panel.open{transform:translateX(0)}
  .panel header{padding:14px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between}
  .panel h3{margin:0; font-size:1rem}
  .panel .close{appearance:none; border:1px solid #e6e6e6; background:#fff; padding:.35rem .6rem; border-radius:10px; cursor:pointer}
  .panel .sec{padding:14px 16px; border-bottom:1px dashed #eee}
  .panel .row{display:flex; gap:.5rem; flex-wrap:wrap}
  .panel button, .panel select, .panel input[type="number"]{
    appearance:none; border:1px solid #ddd; background:#fff; color:#222;
    padding:.55rem .7rem; border-radius:.7rem; font-size:.92rem; box-shadow:0 1px 0 #fff inset, 0 1px 2px var(--shadow);
  }
  .panel button.primary{border-color:var(--accent); background:var(--accent); color:#fff}

  #toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#111; color:#fff; padding:.65rem .9rem; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.25); z-index:99; font-size:.94rem; opacity:0; transition:opacity .2s}

  /* --- Bubble ƒë·ªãnh d·∫°ng n·ªïi --- */
  .fmt-bubble{
    position:fixed; z-index:50; background:#fff; border:1px solid #e6e6e6; border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.18); padding:.35rem .45rem; display:none; gap:.25rem; align-items:center;
  }
  .fmt-bubble button{
    appearance:none; background:#fff; border:1px solid #e2e2e2; border-radius:8px; padding:.35rem .5rem;
    font-weight:600; cursor:pointer;
  }
  .fmt-bubble .chip{width:22px; height:22px; border-radius:50%; border:1px solid rgba(0,0,0,.1); padding:0}
  .fmt-bubble .chip[title="ƒêen"]{background:#000}
  .fmt-bubble .chip[title="ƒê·ªè"]{background:#d93025}
  .fmt-bubble .chip[title="Cam"]{background:#f9ab00}
  .fmt-bubble .chip[title="Xanh l√°"]{background:#188038}
  .fmt-bubble .chip[title="Xanh d∆∞∆°ng"]{background:#1a73e8}
  .fmt-bubble .chip[title="T√≠m"]{background:#a142f4}
  .fmt-bubble .sep{width:1px; height:20px; background:#eee; margin:0 .25rem}
</style>
</head>
<body>
  <div class="stage">
    <div class="book" id="book">
      <!-- Gear -->
      <button class="gear" id="gearBtn" title="C√†i ƒë·∫∑t & L∆∞u">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 7.04 2.4l.06.06a1.65 1.65 0 0 0 1.82.33h0A1.65 1.65 0 0 0 10.42 1H10.5a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h0a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v0c.23.58.86 1 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </button>

      <!-- Panel -->
      <aside class="panel" id="panel">
        <header>
          <h3>‚öôÔ∏è C√†i ƒë·∫∑t & L∆∞u</h3>
          <button class="close" id="closePanel">ƒê√≥ng</button>
        </header>

        <div class="sec">
          <strong>Ki·ªÉu ch·ªØ & c·ª°:</strong>
          <div class="row" style="margin-top:.5rem">
            <label>Ph√¥ng:
              <select id="fontSelect">
                <option value="type">ƒê√°nh m√°y</option>
                <option value="hand">Ch·ªØ vi·∫øt tay</option>
              </select>
            </label>
            <label>C·ª° ch·ªØ:
              <input id="fontSize" type="number" min="12" max="40" step="1" value="18" style="width:72px">
            </label>
          </div>
        </div>

        <div class="sec">
          <strong>Trang & S·ªï:</strong>
          <div class="row" style="margin-top:.5rem">
            <button id="newPageBtn">+ Trang m·ªõi</button>
            <button id="savePageBtn" class="primary" title="Ctrl/Cmd+S">L∆∞u trang</button>
            <button id="saveBookBtn">L∆∞u s·ªï</button>
            <button id="loadBookBtn">T·∫£i s·ªï</button>
          </div>
        </div>

        <div class="sec">
          <strong>Sao l∆∞u:</strong>
          <div class="row" style="margin-top:.5rem">
            <button id="exportBtn">Xu·∫•t JSON</button>
            <button id="importBtn">Nh·∫≠p JSON</button>
            <button id="resetBtn" title="Xo√° s·∫°ch s·ªï (c·∫©n th·∫≠n)">Xo√° s·ªï</button>
          </div>
        </div>

        <div class="sec">
          <strong>Ph√≠m t·∫Øt:</strong>
          <div style="margin-top:.5rem; font-size:.92rem; color:#444">
            ‚Ä¢ L·∫≠t trang: ‚Üê / ‚Üí ho·∫∑c b·∫•m **m√©p tr√°i/ph·∫£i**<br>
            ‚Ä¢ L∆∞u trang: Ctrl/Cmd + S &nbsp; ‚Ä¢ Trang m·ªõi: Alt + N
          </div>
        </div>
      </aside>

      <!-- Trang -->
      <div class="page" id="page">
        <div class="paper" id="paper" contenteditable="true" spellcheck="false"></div>
        <div class="flip-layer" id="flipLayer"></div>
        <div class="corner"></div>

        <!-- g·ªù l·∫≠t -->
        <div class="zones">
          <div class="left" id="zoneLeft" title="Trang tr∆∞·ªõc"></div>
          <div class="right" id="zoneRight" title="Trang sau"></div>
        </div>

        <div class="footer">
          <div class="pill"><span id="pageInfo">Trang 1 / 1</span></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bubble ƒë·ªãnh d·∫°ng n·ªïi -->
  <div class="fmt-bubble" id="fmtBubble" role="toolbar" aria-label="ƒê·ªãnh d·∫°ng">
    <button id="btnBold" title="In ƒë·∫≠m (Ctrl/Cmd+B)"><strong>B</strong></button>
    <div class="sep"></div>
    <button class="chip" data-color="#000000" title="ƒêen"></button>
    <button class="chip" data-color="#d93025" title="ƒê·ªè"></button>
    <button class="chip" data-color="#f9ab00" title="Cam"></button>
    <button class="chip" data-color="#188038" title="Xanh l√°"></button>
    <button class="chip" data-color="#1a73e8" title="Xanh d∆∞∆°ng"></button>
    <button class="chip" data-color="#a142f4" title="T√≠m"></button>
    <div class="sep"></div>
    <button id="btnClear" title="B·ªè ƒë·ªãnh d·∫°ng">‚úï</button>
  </div>

  <div id="toast"></div>

<script>
(function(){
  const KEY='vocab_notebook_v4';

  const pageEl = document.getElementById('page');
  const paperEl = document.getElementById('paper');
  const flipLayer = document.getElementById('flipLayer');
  const pageInfoEl = document.getElementById('pageInfo');

  const gearBtn = document.getElementById('gearBtn');
  const panel = document.getElementById('panel');
  const closePanel = document.getElementById('closePanel');

  const newPageBtn = document.getElementById('newPageBtn');
  const savePageBtn = document.getElementById('savePageBtn');
  const saveBookBtn = document.getElementById('saveBookBtn');
  const loadBookBtn = document.getElementById('loadBookBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const resetBtn = document.getElementById('resetBtn');

  const fontSelect = document.getElementById('fontSelect');
  const fontSize = document.getElementById('fontSize');
  const zoneLeft = document.getElementById('zoneLeft');
  const zoneRight = document.getElementById('zoneRight');

  const fmtBubble = document.getElementById('fmtBubble');
  const btnBold = document.getElementById('btnBold');
  const btnClear = document.getElementById('btnClear');

  let book = { pages:[blankPage()], current:0, style:{mode:'type', size:18} };
  const createdNextFor = new Set();

  function blankPage(){
    return `<div class="ghost">‚Ä¢ G√µ t·ª´ v·ª±ng / v√≠ d·ª•‚Ä¶<br>‚Ä¢ B√¥i ƒëen ƒë·ªÉ ƒë·ªïi <strong>m√†u</strong> / <strong>in ƒë·∫≠m</strong> ‚Ä¢ Ctrl/Cmd+S ƒë·ªÉ l∆∞u trang.</div>`;
  }
  function applyStyle(){
    const m = book.style?.mode || 'type';
    const size = Number(book.style?.size || 18);
    paperEl.style.fontFamily = (m==='hand') ? 'var(--font-hand)' : 'var(--font-type)';
    paperEl.style.fontSize = size+'px';
    fontSelect.value = m; fontSize.value = size;
  }
  function renderPage(){
    paperEl.innerHTML = book.pages[book.current] ?? blankPage();
    pageInfoEl.textContent = `Trang ${book.current+1} / ${book.pages.length}`;
    applyStyle();
    // focus ƒë·ªÉ g√µ ngay
    setTimeout(()=>{ paperEl.focus(); placeCaretEnd(paperEl); }, 0);
  }
  function placeCaretEnd(el){
    const r = document.createRange(); r.selectNodeContents(el); r.collapse(false);
    const s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
  }
  function clamp(n,min,max){return Math.max(min, Math.min(n,max));}
  function stripHtml(html){const d=document.createElement('div'); d.innerHTML=html; return d.textContent||d.innerText||'';}
  function saveCurrentPageToState(){ book.pages[book.current] = paperEl.innerHTML.trim(); }
  function saveBookToLocal(){ saveCurrentPageToState(); localStorage.setItem(KEY, JSON.stringify(book)); toast('‚úÖ ƒê√£ l∆∞u s·ªï.'); }
  function loadBookFromLocal(){
    const raw = localStorage.getItem(KEY);
    if(!raw){ toast('‚ÑπÔ∏è Ch∆∞a c√≥ s·ªï ƒë√£ l∆∞u.'); return; }
    try{
      const data = JSON.parse(raw);
      if(!Array.isArray(data.pages)) throw 0;
      book = data; book.current = clamp(book.current,0,book.pages.length-1);
      renderPage(); toast('üì• ƒê√£ t·∫£i s·ªï.');
    }catch{ toast('‚ö†Ô∏è D·ªØ li·ªáu h·ªèng.'); }
  }
  function exportJson(){
    saveCurrentPageToState();
    const blob = new Blob([JSON.stringify(book,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'so-tu-vung.json'});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function importJson(){
    const inp = Object.assign(document.createElement('input'),{type:'file',accept:'application/json'});
    inp.onchange = ()=>{
      const f = inp.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const data = JSON.parse(String(r.result));
          if(!Array.isArray(data.pages)) throw 0;
          book = {
            pages: data.pages,
            current: clamp(data.current??0,0,(data.pages.length||1)-1),
            style: data.style ?? {mode:'type', size:18}
          };
          renderPage(); saveBookToLocal(); toast('‚úÖ ƒê√£ nh·∫≠p JSON.');
        }catch{ toast('‚ö†Ô∏è File JSON kh√¥ng h·ª£p l·ªá.');}
      };
      r.readAsText(f);
    };
    inp.click();
  }
  function addPage(){
    saveCurrentPageToState();
    if(stripHtml(book.pages[book.current]).trim() === stripHtml(blankPage()).trim()){
      book.pages[book.current] = '';
      renderPage(); return;
    }
    book.pages.splice(book.current+1,0,'');
    goto(book.current+1,'right');
  }

  /* --- Realistic flip --- */
  let flipping=false;
  function goto(index, dir='right'){
    saveCurrentPageToState();
    const next = clamp(index,0,book.pages.length-1);
    if(next===book.current){ bump(dir); return; }
    flip(dir, ()=>{ book.current = next; renderPage(); });
  }
  function bump(dir){
    pageEl.classList.add('lifting');
    animateFlip(dir, 0, 12*(dir==='right'?-1:1), 160, ()=>{ pageEl.classList.remove('lifting'); });
  }
  function flip(dir, onHalf){
    if(flipping) return; flipping=true;
    pageEl.classList.add('lifting');
    animateFlip(dir, 0, (dir==='right'? -55:55), 180, ()=>{
      if(typeof onHalf==='function') onHalf();
      animateFlip(dir, (dir==='right'? -55:55), 0, 180, ()=>{
        pageEl.classList.remove('lifting'); flipping=false;
      });
    });
  }
  function animateFlip(dir, fromDeg, toDeg, dur, done){
    const start = performance.now();
    function frame(t){
      const p = Math.min(1, (t-start)/dur);
      const ease = p<.5 ? (2*p*p) : (-1+(4-2*p)*p);
      const deg = fromDeg + (toDeg-fromDeg)*ease;
      pageEl.style.transformOrigin = (dir==='right'?'98% 50%':'2% 50%');
      pageEl.style.transform = `rotateY(${deg}deg)`;
      flipLayer.style.transformOrigin = (dir==='right'?'98% 50%':'2% 50%');
      flipLayer.style.transform = `rotateY(${deg}deg)`;
      if(p<1){ requestAnimationFrame(frame); } else {
        if(toDeg===0){ pageEl.style.transform='none'; flipLayer.style.transform='none'; }
        done && done();
      }
    }
    requestAnimationFrame(frame);
  }

  /* --- Events: l·∫≠t trang ·ªü 2 g·ªù m√©p --- */
  zoneLeft.addEventListener('click', ()=> goto(book.current-1,'left'));
  zoneRight.addEventListener('click', ()=> goto(book.current+1,'right'));

  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveCurrentPageOnly(); }
    else if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='b'){ e.preventDefault(); toggleBold(); }
    else if(e.altKey && e.key.toLowerCase()==='n'){ e.preventDefault(); addPage(); }
    else if(e.key==='ArrowRight'){ e.preventDefault(); goto(book.current+1,'right'); }
    else if(e.key==='ArrowLeft'){ e.preventDefault(); goto(book.current-1,'left'); }
  });

  gearBtn.addEventListener('click', ()=> panel.classList.toggle('open'));
  closePanel.addEventListener('click', ()=> panel.classList.remove('open'));

  newPageBtn.addEventListener('click', addPage);
  function saveCurrentPageOnly(){
    saveCurrentPageToState();
    localStorage.setItem(KEY, JSON.stringify(book));
    maybeAutoCreateNextPage();
    toast(`üíæ ƒê√£ l∆∞u trang ${book.current+1}.`);
  }
  savePageBtn.addEventListener('click', saveCurrentPageOnly);
  saveBookBtn.addEventListener('click', saveBookToLocal);
  loadBookBtn.addEventListener('click', loadBookFromLocal);
  exportBtn.addEventListener('click', exportJson);
  importBtn.addEventListener('click', importJson);
  resetBtn.addEventListener('click', ()=>{
    if(confirm('Xo√° to√†n b·ªô s·ªï? (Kh√¥ng th·ªÉ ho√†n t√°c)')){
      localStorage.removeItem(KEY);
      book = {pages:[blankPage()], current:0, style:{mode:'type', size:18}};
      createdNextFor.clear?.();
      renderPage(); toast('üóëÔ∏è ƒê√£ xo√° s·ªï.');
    }
  });

  fontSelect.addEventListener('change', ()=>{ book.style.mode = fontSelect.value; applyStyle(); saveBookToLocal(); });
  fontSize.addEventListener('change', ()=>{
    const v = Math.max(12, Math.min(40, Number(fontSize.value)||18));
    book.style.size = v; applyStyle(); saveBookToLocal();
  });

  // Auto-save sau 1.2s d·ª´ng g√µ + auto-t·∫°o-trang-m·ªõi (kh√¥ng chuy·ªÉn)
  let typingTimer;
  paperEl.addEventListener('input', ()=>{
    hideBubble();
    clearTimeout(typingTimer);
    typingTimer = setTimeout(()=> { saveCurrentPageOnly(); }, 1200);
  });

  // ti√™u ch√≠ ‚Äúg·∫ßn h·∫øt trang‚Äù -> t·∫°o th√™m 1 trang tr·ªëng ph√≠a sau (ch·ªâ khi ·ªü trang cu·ªëi)
  function maybeAutoCreateNextPage(){
    const atLastPage = (book.current === book.pages.length - 1);
    if(!atLastPage) return;
    if(createdNextFor.has(book.current)) return;

    const remainingPx = paperEl.scrollHeight - paperEl.scrollTop - paperEl.clientHeight;
    const contentLen = stripHtml(paperEl.innerHTML).length;

    const nearBottom = remainingPx <= 120;
    const tooLong = contentLen > 1200;

    if(nearBottom || tooLong){
      book.pages.push('');
      localStorage.setItem(KEY, JSON.stringify(book));
      createdNextFor.add(book.current);
      toast('‚ûï ƒê√£ th√™m trang m·ªõi ph√≠a sau.');
    }
  }

  // ====== BUBBLE: ch·ªçn & ƒë·ªïi m√†u / in ƒë·∫≠m ======
  function selectionInPaper(){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0) return null;
    const range = sel.getRangeAt(0);
    // ki·ªÉm tra selection n·∫±m trong .paper
    if(!paperEl.contains(range.startContainer) || !paperEl.contains(range.endContainer)) return null;
    return {sel, range};
  }

  function showBubble(){
    const info = selectionInPaper();
    if(!info) { hideBubble(); return; }
    const rect = info.range.getBoundingClientRect();
    if(rect.width===0 && rect.height===0){ hideBubble(); return; }

    const bubble = fmtBubble;
    const offset = 8;
    const x = Math.min(window.innerWidth - bubble.offsetWidth - 8, Math.max(8, rect.left + rect.width/2 - bubble.offsetWidth/2));
    const y = Math.max(8, rect.top - bubble.offsetHeight - offset);

    bubble.style.left = x + 'px';
    bubble.style.top = y + 'px';
    bubble.style.display = 'flex';
  }
  function hideBubble(){ fmtBubble.style.display = 'none'; }

  // hi·ªán bubble khi th·∫£ chu·ªôt / ch·ªçn text trong gi·∫•y
  paperEl.addEventListener('mouseup', ()=> setTimeout(showBubble, 0));
  paperEl.addEventListener('keyup', (e)=>{
    if(['Shift','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End'].includes(e.key)) showBubble();
  });

  // click 1 t·ª´ -> t·ª± m·ªü bubble & b√¥i c·∫£ t·ª´
  paperEl.addEventListener('click', (e)=>{
    // ƒë·ª´ng k√≠ch ho·∫°t ·ªü m√©p l·∫≠t
    const inPaper = e.target.closest('.paper');
    if(!inPaper) return;
    const sel = window.getSelection();
    if(!sel) return;
    if(sel.rangeCount===0 || !sel.isCollapsed) return; // ƒë√£ c√≥ b√¥i ƒëen r·ªìi th√¨ gi·ªØ nguy√™n
    // m·ªü r·ªông selection ra to√†n t·ª´ (word)
    const r = document.caretRangeFromPoint ? document.caretRangeFromPoint(e.clientX, e.clientY)
      : (function(){ const rr=document.createRange(); rr.setStart(paperEl,0); rr.collapse(true); return rr; })();
    if(!r) return;
    expandRangeToWord(r);
    sel.removeAllRanges(); sel.addRange(r);
    showBubble();
  });

  function isWordChar(ch){
    return /[A-Za-z√Ä-·ªπ0-9_‚Äô'\-]/.test(ch); // h·ªó tr·ª£ VN, d·∫•u nh√°y, g·∫°ch n·ªëi
  }
  function expandRangeToWord(r){
    const walker = document.createTreeWalker(paperEl, NodeFilter.SHOW_TEXT, null);
    // ƒë·∫£m b·∫£o r.startContainer l√† text node
    if(r.startContainer.nodeType!==Node.TEXT_NODE){
      // n·∫øu l√† element, c·ªë g·∫Øng ƒëi v√†o text node g·∫ßn nh·∫•t
      if(r.startContainer.childNodes.length){
        r.setStart(r.startContainer.firstChild, 0);
      }
    }
    // t√¨m text node & index
    let node = r.startContainer;
    let index = r.startOffset;
    if(node.nodeType!==Node.TEXT_NODE) return;
    const text = node.textContent || '';
    // m·ªü r·ªông tr√°i
    let L=index, R=index;
    while(L>0 && isWordChar(text[L-1])) L--;
    while(R<text.length && isWordChar(text[R])) R++;
    r.setStart(node, L);
    r.setEnd(node, R);
  }

  // thao t√°c ƒë·ªãnh d·∫°ng
  btnBold.addEventListener('click', ()=>{ toggleBold(); saveCurrentPageOnly(); setTimeout(showBubble,0); });
  btnClear.addEventListener('click', ()=>{ clearFormat(); saveCurrentPageOnly(); hideBubble(); });

  // palette m√†u
  fmtBubble.querySelectorAll('.chip').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const color = btn.getAttribute('data-color');
      applyColor(color);
      saveCurrentPageOnly();
      setTimeout(showBubble,0);
    });
  });

  function toggleBold(){
    // d√πng execCommand cho ƒë∆°n gi·∫£n (v·∫´n ho·∫°t ƒë·ªông t·ªët tr√™n iOS/macOS Safari/Chrome)
    document.execCommand('bold', false, null);
  }

  function applyColor(color){
    const info = selectionInPaper();
    if(!info) return;
    const {sel, range} = info;
    if(sel.isCollapsed){
      // n·∫øu kh√¥ng b√¥i ƒëen, b·ªè qua
      return;
    }
    // chu·∫©n ho√°: bao range b·∫±ng <span style="color:...">
    wrapRangeWithSpan(range, {color});
  }

  function clearFormat(){
    const info = selectionInPaper();
    if(!info) return;
    const {sel, range} = info;
    if(sel.isCollapsed) return;
    // b·ªè strong/span color trong selection: thay b·∫±ng text thu·∫ßn
    const frag = range.cloneContents();
    // strip style
    stripStyles(frag);
    // replace
    range.deleteContents();
    range.insertNode(frag);
    // g·ªôp text nodes li·ªÅn k·ªÅ ƒë·ªÉ s·∫°ch DOM
    paperEl.normalize();
  }

  function stripStyles(root){
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
    const toUnwrap = [];
    let n;
    while(n = walker.nextNode()){
      const tag = n.tagName;
      if(tag==='SPAN' || tag==='B' || tag==='STRONG' || tag==='FONT'){
        toUnwrap.push(n);
      }
    }
    toUnwrap.forEach(el=>{
      // gi·ªØ l·∫°i m√†u n·∫øu kh√¥ng mu·ªën? ·ªû ƒë√¢y l√† clear n√™n b·ªè
      while(el.firstChild) el.parentNode.insertBefore(el.firstChild, el);
      el.remove();
    });
  }

  function wrapRangeWithSpan(range, styleObj){
    const span = document.createElement('span');
    if(styleObj.color) span.style.color = styleObj.color;
    // n·∫øu range c√≥ th·ªÉ surround tr·ª±c ti·∫øp:
    try{
      range.surroundContents(span);
    }catch{
      // fallback: extract & b·ªçc
      const frag = range.extractContents();
      span.appendChild(frag);
      range.insertNode(span);
    }
    // gi·ªØ selection tr√™n span ƒë·ªÉ ch·ªânh ti·∫øp
    const sel = window.getSelection();
    sel.removeAllRanges();
    const r = document.createRange();
    r.selectNodeContents(span);
    sel.addRange(r);
  }

  // ·∫©n bubble khi click ngo√†i gi·∫•y
  document.addEventListener('mousedown', (e)=>{
    if(!e.target.closest('.fmt-bubble') && !e.target.closest('.paper')) hideBubble();
  });

  // init
  try{
    const raw = localStorage.getItem(KEY);
    if(raw){ const data = JSON.parse(raw); if(Array.isArray(data.pages)) book = data; }
  }catch{}
  if(!Array.isArray(book.pages) || book.pages.length===0){ book.pages=[blankPage()]; book.current=0; }
  renderPage();

  /* toast helper */
  let toastTimer;
  function toast(msg){
    const el = document.getElementById('toast');
    el.textContent = msg; clearTimeout(toastTimer);
    el.style.opacity='1'; toastTimer=setTimeout(()=> el.style.opacity='0', 1600);
  }
})();
</script>
</body>
</html>
